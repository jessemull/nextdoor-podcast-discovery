# CI: Lint, test, security, and build on PR and push to main
name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # Required pre-merge: lint (includes format check), test, security, build.
  lint-test-security-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            scraper/requirements.txt
            scraper/requirements-dev.txt

      - name: Create virtual environment
        run: python -m venv .venv

      - name: Install scraper dependencies
        run: |
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -r scraper/requirements.txt -r scraper/requirements-dev.txt

      - name: Install Playwright browsers (Chromium)
        run: cd scraper && ../.venv/bin/playwright install chromium

      - name: Install web dependencies
        run: cd web && npm ci --legacy-peer-deps

      - name: Lint (scraper + web)
        run: make lint

      - name: Test (scraper + web)
        run: make test

      - name: Security (scraper + web)
        run: make security

      - name: Build web
        run: make build
