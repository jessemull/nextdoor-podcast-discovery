# Nextdoor Podcast Discovery Platform — Cursor Rules

## Project Overview

This is a monorepo with two main components:
- `/scraper` — Python 3.11+ scraper and LLM workers (runs in GitHub Actions)
- `/web` — Next.js 14+ TypeScript frontend (deploys to Vercel)

Database: Supabase (PostgreSQL + pgvector)
LLM: Claude Haiku for scoring, OpenAI for embeddings

---

## General Principles

- Prefer simple solutions over clever ones
- Don't over-engineer; this is a small project
- Respect the cost-optimized architecture (free tiers + pay-per-use APIs)
- All secrets come from environment variables, never hardcode them

---

## Alphabetization Rules

Always alphabetize the following when possible:

### Python
- **Imports within groups:** After grouping by stdlib → third-party → local, sort alphabetically within each group
- **Dictionary keys:** Sort keys alphabetically when defining dict literals
- **List items:** Sort string lists alphabetically when order doesn't matter (e.g., `REQUIRED_ENV_VARS`)
- **Class methods:** Sort methods alphabetically (after `__init__` and special methods)

### TypeScript/React
- **Imports:** Sort by package name (external first, then @/ internal, then relative)
- **Named imports:** Sort members alphabetically: `import { A, B, C } from 'x'`
- **Object keys:** Sort object literal keys alphabetically
- **Interface/Type properties:** Sort alphabetically
- **JSX props:** Sort alphabetically, with `key` first and callbacks (`on*`) last
- **Union types:** Sort alphabetically: `null | number | string`
- **CSS classes in className:** Sort alphabetically when practical

**Enforced by:** `eslint-plugin-perfectionist` for TypeScript (configured in `.eslintrc.json`)

---

## Comment Spacing Rules

### General Comments in Code
- **Empty line above and below:** Standalone comments should have an empty line above and below them for readability
- **Block start exception:** If a comment is at the start of a code block (e.g., first line of a function body), it should only have an empty line below it, not above
- **Block end exception:** If a comment is at the end of a code block, it should only have an empty line above it, not below

### JSX Comments
- **No empty lines:** Comments inside JSX should NOT have empty lines above or below them (keeps JSX compact)

### Function/Class Documentation
- **Docstrings (Python):** Triple-quoted docstrings directly below the function/class signature, no blank line between
- **JSDoc (TypeScript):** Block comments directly above the function/component, no blank line between comment and declaration

### Examples

**Good (Python):**
```python
def process_data():
    # Validate input first

    validated = validate(data)

    # Transform the data

    return transform(validated)
```

**Good (TypeScript):**
```typescript
function Component() {
  return (
    <div>
      {/* Header section */}
      <header>...</header>
      {/* Content section */}
      <main>...</main>
    </div>
  );
}
```

---

## Python Guidelines (`/scraper`)

### Structure
- Use `src/` layout with `__init__.py` files
- Entry point: `src/main.py`
- One class/function per responsibility

### Style
- Follow PEP 8
- Use type hints for all function signatures
- Use `snake_case` for functions and variables
- Use `PascalCase` for classes
- Constants in `UPPER_SNAKE_CASE`

### Imports
- Order: stdlib → third-party → local
- Alphabetize within each group
- Use absolute imports: `from src.scraper import NextdoorScraper`

### Error Handling
- Use custom exceptions (defined in `src/exceptions.py`)
- Always use `tenacity` for API retry logic
- Log errors with `logging` module, include context

### Dependencies
- Playwright for browser automation (headless mode only)
- `anthropic` for Claude API
- `openai` for embeddings
- `supabase` for database
- `cryptography` for session encryption

### Testing
- Use `pytest`
- Test files: `tests/test_*.py`
- Mock external APIs (Claude, OpenAI, Supabase)
- Use `vitest` for TypeScript (web)

---

## Testing Philosophy

Tests should serve three purposes: **documentation**, **confidence**, and **safety**.

### Core Principles

1. **Tests document the code** — Test names and structure should explain what the code does. Someone reading tests should understand the expected behavior.

2. **Cover happy and sad paths** — Every function with logic should have tests for:
   - Success cases (happy path)
   - Failure cases (sad path)
   - Edge cases (null, empty, boundary values)

3. **Tests enable safe refactoring** — If tests pass after a refactor, the behavior is preserved. Tests should catch regressions.

4. **Don't overtest** — Focus on behavior, not implementation details. Don't test:
   - Every line of code
   - Private/internal functions
   - Third-party library behavior
   - Simple getters/setters

### What to Test

| Test | Don't Test |
|------|------------|
| Public APIs and functions | Internal implementation details |
| Business logic | Framework/library code |
| Edge cases and error handling | Simple pass-through functions |
| Integration points (APIs, DB) | Trivial code (getters, setters) |

### Test Structure

```python
# Python
def test_function_does_something_when_condition():
    """Should [expected behavior] when [condition]."""
    # Arrange
    # Act
    # Assert
```

```typescript
// TypeScript
it("should [expected behavior] when [condition]", () => {
  // Arrange
  // Act
  // Assert
});
```

### Guidelines

- **One concept per test** — Each test verifies one logical behavior
- **Descriptive names** — Test name should describe the scenario and expectation
- **Fast tests** — Tests should run quickly to encourage frequent runs
- **Isolated tests** — Tests should not depend on each other or external state
- **Test behavior, not implementation** — Verify *what* code does, not *how*

---

## TypeScript/Next.js Guidelines (`/web`)

### Structure
- Use Next.js App Router (`app/` directory)
- API routes in `app/api/`
- Components in `components/`
- Server-only utilities in `lib/*.server.ts`
- Client utilities in `lib/*.client.ts`

### Style
- Use TypeScript strict mode
- Use `camelCase` for functions and variables
- Use `PascalCase` for components and types
- Prefer `interface` over `type` for object shapes
- Use named exports, not default exports

### Components
- Use functional components with hooks
- Colocate component-specific types in the same file
- Use React Query (TanStack) for server state
- Use Tailwind CSS for styling

### API Routes
- Validate request data before processing
- Return consistent JSON responses: `{ data }` or `{ error }`
- Use `getServerSession` for auth checks

### Database
- Use `getSupabase()` from `lib/supabase.client.ts` for client-side
- Use `getSupabaseAdmin()` from `lib/supabase.server.ts` for server-side
- Never expose service keys to client

### Auth
- NextAuth.js with Google OAuth
- Email whitelist in `lib/auth.ts`
- Protect routes with middleware or `getServerSession`

---

## Database Conventions

- UUIDs for all primary keys
- `created_at` and `updated_at` timestamps on mutable tables
- Use `TIMESTAMPTZ` not `TIMESTAMP`
- JSONB for flexible data (tags, image_urls)
- Index columns used in WHERE clauses
- Triggers maintain `updated_at` automatically

---

## Git Conventions

- Branch naming: `feature/description`, `fix/description`
- Commit messages: imperative mood ("Add feature", not "Added feature")
- Keep PRs focused on one change

---

## When Writing Code

1. Check if similar code exists before creating new files
2. Follow existing patterns in the codebase
3. Add type hints (Python) or types (TypeScript)
4. Handle errors gracefully with informative messages
5. Don't add dependencies unless necessary
6. Keep functions small and focused
7. Write code that's easy to test
8. **Alphabetize** imports, object keys, props, and list items
9. **Space comments** appropriately (see Comment Spacing Rules)

---

## Project-Specific Notes

### Claude API Usage
- Model: `claude-3-haiku-20240307` (not Sonnet — cost optimization)
- Always request JSON responses for structured data
- Batch posts when possible to reduce API calls

### OpenAI API Usage
- Model: `text-embedding-3-small` (1536 dimensions)
- Batch up to 100 texts per request

### Supabase
- Free tier: 500MB storage limit
- Use HNSW index for vector similarity
- Store session cookies encrypted (Fernet)
- Environment variable: `SUPABASE_SERVICE_KEY` (consistent across Python and TypeScript)

### Special Features
- Pittsburgh sports facts: Only for user with USER_EMAIL env var
- Uses Claude Haiku, called on login

---

## Quality Commands

```bash
# Run all linters
make lint

# Run all tests
make test

# Run security scans
make security

# Format code
make format
```
